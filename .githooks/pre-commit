#!/bin/sh
# Pre-commit hook: scan for exposed secrets in staged files

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "üîç Scanning for exposed secrets..."

ISSUES=0

# Get list of staged files (excluding deleted files)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=d)

if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Check if .env is staged (should never be committed)
if echo "$STAGED_FILES" | grep -qE '^\.env$|^\.env\.local$'; then
  echo "${RED}BLOCKED:${NC} .env file is staged for commit. Remove it with: git reset HEAD .env"
  ISSUES=$((ISSUES + 1))
fi

# Scan staged content for secret patterns (skip .env.example, binary files, and security docs)
SCAN_FILES=$(echo "$STAGED_FILES" | grep -vE '\.env\.example$|\.png$|\.jpg$|\.ico$|\.woff|\.ttf|\.lock$|pre-commit-security/SKILL\.md$|\.githooks/pre-commit$')

for file in $SCAN_FILES; do
  if [ ! -f "$file" ]; then
    continue
  fi

  # Get only the staged content
  CONTENT=$(git diff --cached -- "$file" | grep '^+' | grep -v '^+++')

  # Figma API keys
  if echo "$CONTENT" | grep -qE 'figd_[A-Za-z0-9_-]{10,}'; then
    echo "${RED}BLOCKED:${NC} Figma API key found in ${YELLOW}$file${NC}"
    ISSUES=$((ISSUES + 1))
  fi

  # Google API keys
  if echo "$CONTENT" | grep -qE 'AIza[A-Za-z0-9_-]{35}'; then
    echo "${RED}BLOCKED:${NC} Google API key found in ${YELLOW}$file${NC}"
    ISSUES=$((ISSUES + 1))
  fi

  # OpenAI / Stripe secret keys
  if echo "$CONTENT" | grep -qE 'sk-[A-Za-z0-9]{20,}'; then
    echo "${RED}BLOCKED:${NC} Secret key (sk-) found in ${YELLOW}$file${NC}"
    ISSUES=$((ISSUES + 1))
  fi

  # GitHub PATs
  if echo "$CONTENT" | grep -qE 'gh[po]_[A-Za-z0-9]{36}'; then
    echo "${RED}BLOCKED:${NC} GitHub token found in ${YELLOW}$file${NC}"
    ISSUES=$((ISSUES + 1))
  fi

  # Slack tokens
  if echo "$CONTENT" | grep -qE 'xox[bp]-[A-Za-z0-9-]+'; then
    echo "${RED}BLOCKED:${NC} Slack token found in ${YELLOW}$file${NC}"
    ISSUES=$((ISSUES + 1))
  fi

  # Private keys
  if echo "$CONTENT" | grep -qE 'BEGIN (RSA |EC |DSA )?PRIVATE KEY'; then
    echo "${RED}BLOCKED:${NC} Private key found in ${YELLOW}$file${NC}"
    ISSUES=$((ISSUES + 1))
  fi

  # Hardcoded passwords in source code (not .env files)
  if echo "$file" | grep -qE '\.(ts|tsx|js|jsx|json)$'; then
    if echo "$CONTENT" | grep -qiE '"password"\s*:\s*"[^"]{4,}"' | grep -vE 'env|process|import\.meta'; then
      echo "${YELLOW}WARNING:${NC} Possible hardcoded password in ${YELLOW}$file${NC}"
      ISSUES=$((ISSUES + 1))
    fi
  fi
done

# Verify .gitignore has .env
if [ -f .gitignore ]; then
  if ! grep -qE '^\s*\.env\s*$' .gitignore; then
    echo "${RED}BLOCKED:${NC} .env is not in .gitignore"
    ISSUES=$((ISSUES + 1))
  fi
fi

if [ $ISSUES -gt 0 ]; then
  echo ""
  echo "${RED}‚úó Commit blocked: $ISSUES security issue(s) found${NC}"
  echo "Fix the issues above and try again."
  exit 1
else
  echo "${GREEN}‚úì No secrets detected${NC}"
  exit 0
fi
